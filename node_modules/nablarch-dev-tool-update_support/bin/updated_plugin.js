'use strict';
require('sugar');

var fs       = require('fs')
  , path     = require('path')
  , versions = require('../lib/versions');

//定数定義
var PROJECT_ROOT    = process.env.PROJECT_ROOT
  , UI_PLUGINS_DIRS = process.env.UI_PLUGINS_DIRS
                    ? process.env.UI_PLUGINS_DIRS.split(',') : ['ui_plugins']
  , PLUGIN_DIR      = process.env.PLUGIN_DIR
                    ? process.env.PLUGIN_DIR :'../node_modules'
  , CURRENT_VERSION = versions(PLUGIN_DIR)
  , PJ_PLUGINS_DIRS = UI_PLUGINS_DIRS.map(function(pluginsDir) {
                        return path.join(PROJECT_ROOT, pluginsDir).trim();
                      })
  , RESULT_FILE     = 'updated_plugin.json';

function main() {
  // PJにあるプラグイン毎に更新状態を確認する。
  PJ_PLUGINS_DIRS.each(function(uiPluginsDir) {
    var plugins;
    if (!fs.existsSync(uiPluginsDir)) {
      console.log(path.resolve(uiPluginsDir), 'is not found.');
      return false; // 指定されたディレクトリがない場合は、検知した時点で処理終了。
    }
    plugins = CURRENT_VERSION.diff(versions(path.join(uiPluginsDir,'node_modules')).info);
    if(Object.keys(plugins).isEmpty()) {
      console.log("can not find unmatch-version plugin. [" + uiPluginsDir + "]");
      return;
    }
    fs.writeFileSync(path.join(uiPluginsDir, RESULT_FILE), JSON.stringify(plugins, null, 4));
    console.log("write unmatch-version plugin(s) to " + path.resolve(uiPluginsDir, RESULT_FILE));
  });
}

main();
